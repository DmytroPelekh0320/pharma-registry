<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Історія запитів</title>
</head>
<body>
    <h2>Історія запитів користувача</h2>

    <table border="1">
        <tr>
            <th>Дата</th>
            <th>Назва</th>
            <th>Форма</th>
            <th>МНН</th>
            <th>Країна</th>
            <th>Кількість</th>
            <th>Деталі</th>
        </tr>
        {% for record in records %}
        <tr>
            <td>{{ record.timestamp }}</td>
            <td>{{ record.name_filter or "—" }}</td>
            <td>{{ record.form_filter or "—" }}</td>
            <td>{{ record.inn_filter or "—" }}</td>
            <td>
                {% set first_country = record.results[0]["Країна виробника"] if record.results and record.results[0].get("Країна виробника") else "—" %}
                {{ first_country }}
            </td>
            <td>{{ record.result_count }}</td>
            <td>
                <button onclick="toggleDetails('row{{ loop.index }}')">Показати</button>
            </td>
        </tr>
        <tr id="row{{ loop.index }}" style="display: none;">
            <td colspan="7">
                {% if record.results and record.results|length > 0 %}
                    <table border="1" style="margin-top: 10px;">
                        <tr>
                            <th>#</th>
                            <th>Назва</th>
                            <th>Форма</th>
                            <th>МНН</th>
                            <th>Країна</th>
                        </tr>
                        {% for item in record.results %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ item.get("Торгівельне найменування", "—") }}</td>
                            <td>{{ item.get("Форма випуску", "—") }}</td>
                            <td>{{ item.get("Міжнародне непатентоване найменування", "—") }}</td>
                            <td>{{ item.get("Країна виробника", "—") }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                    <br>
                    <a href="{{ url_for('download', record_id=record.id) }}">Завантажити CSV</a>
                {% else %}
                    <p>Немає результатів.</p>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>

    <br>
    <a href="{{ url_for('index') }}">Повернутися до пошуку</a>

    <!-- Підключення toggle.js -->
    <script src="{{ url_for('static', filename='js/toggle.js') }}"></script>
</body>
</html>
